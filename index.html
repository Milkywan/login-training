<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login — Data Training</title>
  <style>
    body{min-height:100vh;display:flex;align-items:center;justify-content:center;background:#f6f7fb;margin:0;font-family:Arial,sans-serif}
    .card{background:#fff;max-width:420px;width:100%;padding:24px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.07)}
    h1{text-align:center;margin:0 0 12px;font-size:20px}
    label{display:block;margin:10px 0 6px;font-weight:600;font-size:13px;color:#333}
    input{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;box-sizing:border-box}
    .row{display:flex;gap:10px;margin-top:12px}
    button{width:100%;padding:12px;border:none;border-radius:10px;font-size:15px;cursor:pointer}
    .btn-primary{background:#4f46e5;color:#fff}
    .btn-secondary{background:#f59e0b;color:#fff}
    .msg{min-height:20px;margin-top:12px;font-size:14px;text-align:center}
    .msg.error{color:#b91c1c}
    .msg.ok{color:#15803d}
    .hint{font-size:12px;color:#666;margin-top:8px;text-align:center}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="card">

    <!-- LOGIN FORM -->
    <div id="loginForm">
      <h1>Login — Data Training</h1>
      <label for="login-username">Username</label>
      <input id="login-username" placeholder="cth: irwan" autocomplete="username" />
      <label for="login-password">Password</label>
      <input id="login-password" type="password" placeholder="••••••" autocomplete="current-password" />
      <div class="row">
        <button id="loginBtn" class="btn-primary">Masuk</button>
      </div>
      <div id="loginMessage" class="msg"></div>
      <div class="hint">Belum punya akun? <a href="#" onclick="showRegister()">Daftar Sekarang</a></div>
    </div>

    <!-- REGISTER FORM -->
    <div id="registerForm" class="hidden">
      <h1>Daftar — Data Training</h1>
      <label for="reg-username">Username</label>
      <input id="reg-username" placeholder="cth: irwan" />
      <label for="reg-email">Email</label>
      <input id="reg-email" type="email" placeholder="cth: irwan@gmail.com" />
      <label for="reg-password">Password</label>
      <input id="reg-password" type="password" placeholder="••••••" />
      <div class="row">
        <button id="registerBtn" class="btn-secondary">Daftar</button>
      </div>
      <div id="registerMessage" class="msg"></div>
      <div class="hint">Sudah punya akun? <a href="#" onclick="showLogin()">Login</a></div>
    </div>

  </div>

  <script type="module">
  import { auth, db } from "./firebase-config.js";
  import {
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
  import {
    doc, setDoc, getDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

  // Toggle form
  window.showRegister = () => {
    document.getElementById("loginForm").classList.add("hidden");
    document.getElementById("registerForm").classList.remove("hidden");
  };
  window.showLogin = () => {
    document.getElementById("registerForm").classList.add("hidden");
    document.getElementById("loginForm").classList.remove("hidden");
  };

  // === LOGIN ===
  const loginBtn = document.getElementById("loginBtn");
  loginBtn.addEventListener("click", async () => {
    const username = document.getElementById("login-username").value.trim();
    const password = document.getElementById("login-password").value;
    const msgEl = document.getElementById("loginMessage");
    msgEl.textContent = "";
    try {
      if (!username || !password) throw new Error("Isi username & password.");
      const email = `${username}@datatraining.local`; // dummy email dari username
      const cred = await signInWithEmailAndPassword(auth, email, password);
      const uid = cred.user.uid;
      const snap = await getDoc(doc(db, "users", uid));
      if (!snap.exists()) throw new Error("Data akun tidak lengkap. Hubungi admin.");
      if (snap.data().approved !== true) throw new Error("Akun Anda belum di-approve admin.");
      localStorage.setItem("loginTime", Date.now());
      msgEl.textContent = "Login sukses. Mengarahkan...";
      msgEl.className = "msg ok";
      setTimeout(() => window.location.href = "home.html", 800);
    } catch (e) {
      msgEl.textContent = e.message || "Login gagal.";
      msgEl.className = "msg error";
    }
  });

  // === REGISTER ===
  const registerBtn = document.getElementById("registerBtn");
  registerBtn.addEventListener("click", async () => {
    const username = document.getElementById("reg-username").value.trim();
    const email = document.getElementById("reg-email").value.trim();
    const password = document.getElementById("reg-password").value;
    const msgEl = document.getElementById("registerMessage");
    msgEl.textContent = "";
    try {
      if (!username || !email || !password) throw new Error("Isi semua field.");
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      const uid = cred.user.uid;
      // simpan ke pendaftar
      await setDoc(doc(db, "pendaftar", uid), {
        username, email, password, createdAt: serverTimestamp()
      });
      // simpan ke users
      await setDoc(doc(db, "users", uid), {
        username, email, approved: false, createdAt: serverTimestamp()
      });
      await signOut(auth);
      msgEl.textContent = "Pendaftaran berhasil. Tunggu approval admin.";
      msgEl.className = "msg ok";
    } catch (e) {
      msgEl.textContent = e.message || "Pendaftaran gagal.";
      msgEl.className = "msg error";
    }
  });
  </script>
</body>
</html>
